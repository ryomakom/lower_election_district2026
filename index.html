<script>
(async function main() {

  const REGIONS_CSV   = "./regions.csv";
  const GEOMETRY_JSON = "./region_geometry.geojson";
  const POINTS_CSV    = "./points.csv";

  const REGION_COLOR_COL    = "category";
  const REGION_POPUP_COL    = "popup_text";
  const REGION_DISTRICT_COL = "district";
  const REGIONS_ID_COL      = "id";
  const GEOM_ID_PROP        = "id";

  const POINT_X_COL = "longitude";
  const POINT_Y_COL = "latitude";
  const POINT_LABEL_COL = "label";
  const POINT_CAT_COL   = "category";
  const POINT_ID_COL    = "id";

  const regionColorMap = {
    "prefecture": "#e3e3e3",
    "与党": "#BC3939",
    "野党": "#446093",
    "その他": "#959595"
  };

  function getRegionColor(category){
    return regionColorMap[String(category ?? "").trim()] || "#e6e6e6";
  }

  const wrap = document.getElementById("wrap");
  const svg = d3.select("#svg");
  const tooltip = d3.select("#tooltip");

  const [regionsRows, geom, pointsRows] = await Promise.all([
    d3.csv(REGIONS_CSV, d => d),
    d3.json(GEOMETRY_JSON),
    d3.csv(POINTS_CSV, d => d)
  ]);

  const regionsById = new Map(
    regionsRows.map(d => [String(d[REGIONS_ID_COL]).trim(), d])
  );

  const projection = d3.geoIdentity().reflectY(true);
  const path = d3.geoPath(projection);

  const g = svg.append("g");
  const gPref     = g.append("g");
  const gDistrict = g.append("g");
  const gLabels   = g.append("g");

  svg.call(
    d3.zoom().scaleExtent([1,12])
      .on("zoom", e => g.attr("transform", e.transform))
  );

  function render(){

    const { width, height } = wrap.getBoundingClientRect();
    svg.attr("viewBox", `0 0 ${width} ${height}`);

    projection.fitSize([width, height], geom);

    const prefFeatures = geom.features.filter(f => f.properties.type === "prefecture");
    const districtFeatures = geom.features.filter(f => f.properties.type === "district");

    // -------------------------------
    // ★ districtの実寸(px)を取得
    // -------------------------------
    const widths = districtFeatures.map(f=>{
      const b = path.bounds(f);
      return b[1][0] - b[0][0];
    }).filter(w=>w>0).sort((a,b)=>a-b);

    const cellPx = widths[Math.floor(widths.length/2)] || 0;

    // -------------------------------
    // ★ 文字サイズをcellPx基準で決定
    // -------------------------------
    const partyFontPx = cellPx * 0.45;   // ← 調整値
    const prefFontPx  = cellPx * 0.45;

    const dxHalfCell = cellPx / 2;
    const prefShift  = prefFontPx * 0.5;

    // -------------------------------
    // prefecture
    // -------------------------------
    gPref.selectAll("path")
      .data(prefFeatures)
      .join("path")
      .attr("class","prefecture")
      .attr("d",path)
      .attr("fill","#e3e3e3");

    // -------------------------------
    // district
    // -------------------------------
    gDistrict.selectAll("path")
      .data(districtFeatures)
      .join("path")
      .attr("class","district")
      .attr("d",path)
      .attr("fill",f=>{
        const row = regionsById.get(String(f.properties.id).trim());
        return getRegionColor(row?.[REGION_COLOR_COL]);
      });

    // -------------------------------
    // labels
    // -------------------------------
    const validPoints = pointsRows.filter(d =>
      Number.isFinite(+d[POINT_X_COL]) &&
      Number.isFinite(+d[POINT_Y_COL])
    );

    gLabels.selectAll("text")
      .data(validPoints)
      .join("text")
      .attr("class","point-label")
      .attr("transform",d=>{
        const p = projection([+d[POINT_X_COL],+d[POINT_Y_COL]]);
        const isPref = d[POINT_CAT_COL]==="pref";
        const shift = isPref ? prefShift : 0;
        return `translate(${p[0]+dxHalfCell+shift},${p[1]})`;
      })
      .text(d=>d[POINT_LABEL_COL])
      .style("font-size",d=>{
        return d[POINT_CAT_COL]==="pref"
          ? `${prefFontPx}px`
          : `${partyFontPx}px`;
      })
      .style("fill",d=>d[POINT_CAT_COL]==="pref" ? "#000" : "#fff");
  }

  window.addEventListener("resize",render);
  render();

})();
</script>
